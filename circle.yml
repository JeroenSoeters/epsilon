machine:
  services:
    - docker

dependencies:
  override:
    - git submodule update --init
    - docker info
    - docker pull mwytock/epsilon
    - docker run -d -v $HOME/epsilon:/epsilon --name epsilon mwytock/epsilon tail -f /dev/null

test:
  override:
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' epsilon)" -- bash -c 'cd /epsilon && tools/build_third_party.sh'
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' epsilon)" -- bash -c 'make -j -C /epsilon test'
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' epsilon)" -- bash -c 'cd /epsilon && python setup.py install'
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' epsilon)" -- bash -c 'nosetests epopt'
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' epsilon)" -- bash -c 'python -m epopt.problems.benchmark'
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' epsilon)" -- bash -c 'cd /epsilon && python setup.py bdist_wheel'
    - cp $HOME/epsilon/dist/*.whl $CIRCLE_ARTIFACTS

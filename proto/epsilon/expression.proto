
syntax = "proto3";

message Constant {
  string data_location = 1;
  double scalar = 2;
}

message Variable {
  string variable_id = 1;
}

message Size {
  repeated int32 dim = 1;
}

message Slice {
  int32 start = 1;
  int32 stop = 2;
  int32 step = 3;
}

message Sign {
  enum Type {
    UNKNOWN = 0;
    NEGATIVE = 1;
    POSITIVE = 2;
    ZERO = 3;
  }
  Type sign_type = 1;
}

message Curvature {
  enum Type {
    UNKNOWN = 0;
    AFFINE = 1;
    CONVEX = 2;
    CONCAVE = 3;
    CONSTANT = 4;
  }
  Type curvature_type = 1;

  // Special classes of affine functions which have implementations for
  // composing proximal operators.

  // Elementwise function, e.g. A .* X
  bool elementwise = 2;
  // Scalar multiple, e.g. alpha * X
  bool scalar_multiple = 3;
}

message Cone {
  enum Type {
    UNKNOWN = 0;
    ZERO = 1;           // s == 0
    NON_NEGATIVE = 2;   // s >= 0
    SEMI_DEFINITE = 3;  // S >= 0
  }
  Type cone_type = 1;
}

message ProximalOperator {
  string name = 1;
}

message Expression {
  enum Type {
    // Default value
    UNKNOWN = 0;

    // Indicator (generalized inequality)
    INDICATOR = 1;

    // Leaf nodes
    CONSTANT = 2;
    VARIABLE = 3;

    // Linear operators
    ADD = 10;
    INDEX = 11;
    MULTIPLY = 12;
    MULTIPLY_ELEMENTWISE = 13;
    NEGATE = 14;
    SUM = 15;
    TRANSPOSE = 16;
    HSTACK = 17;
    VSTACK = 18;
    TRACE = 19;
    RESHAPE = 20;

    // Elementwise functions
    ABS = 50;
    POWER = 51;
    SQUARE_ROOT = 52;
    MAX = 53;
    LOG = 54;
    EXP = 55;
    HUBER = 56;

    // Vector functions
    NORM_P = 100;

    // Matrix functions
    LOG_DET = 200;
    NORM_PQ = 201;
    NORM_2_ELEMENTWISE = 202;
  }
  Type expression_type = 1;
  Size size = 2;
  repeated Expression arg = 3;

  // DCP attributes
  Sign sign = 4;
  Curvature curvature = 5;

  // CONSTANT, VARIABLE
  Constant constant = 6;
  Variable variable = 7;

  // INDEX
  repeated Slice key = 8;

  // NORM_P, NORM_P_Q and POWER
  double p = 9;
  double q = 10;

  // INDICATOR
  Cone cone = 11;

  ProximalOperator proximal_operator = 12;
}

// Arbitrary convex problem of the form
// minimize    f(x)
// subject to  f_i(x) <=_K 0
message Problem {
  // Objective should be scalar-valued, f : R^n -> R
  Expression objective = 1;

  // Constraints can be vector-valued, f_i : R^n -> R^m, and should have
  // expression type INDICATOR
  repeated Expression constraint = 2;
}
